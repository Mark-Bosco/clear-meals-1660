name: Publish preview update with APK release

on:
  workflow_dispatch:
  push:
    branches: ['*']

jobs:
  create_preview_build:
    runs-on: ubuntu-latest
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Set up Node.js and EAS CLI
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: üõ† Install dependencies and EAS CLI
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jdk wget git curl unzip zip
          npm install -g eas-cli
          npm install dotenv

      - name: üîê Decode google-services.json
        run: |
          mkdir -p android/app  # üëà Ensure the target directory exists
          echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 --decode > android/app/google-services.json
          if [ -f android/app/google-services.json ]; then
            echo "‚úÖ google-services.json written successfully"
          else
            echo "‚ùå Failed to write google-services.json"
            exit 1
          fi

      - name: üß™ Debug - Check if EXPO_TOKEN is present
        run: echo "EXPO_TOKEN is set? => ${EXPO_TOKEN:+yes}"

      - name: ‚öôÔ∏è Configure EAS project
        run: |
          eas build:configure --platform android

      - name: üìÅ Move google-services.json to android/app
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 --decode > google-services.json
          mkdir -p android/app
          mv google-services.json android/app

      - name: üì¶ Build APK Locally with EAS
        run: |
          eas build --platform android --profile preview --local

      - name: üöÄ Publish GitHub Release with APK
        run: |
          APK_PATH=$(find . -name '*.apk' | head -n 1)
          if [ ! -f "$APK_PATH" ]; then
            echo "‚ùå APK build failed. Aborting."
            exit 1
          fi

          RELEASE_TAG="preview-$(date +'%Y%m%d%H%M')"
          RELEASE_NAME="Preview Build - $(date +'%Y-%m-%d %H:%M:%S')"

          echo "üì¢ Creating GitHub release: $RELEASE_TAG"
          gh release create "$RELEASE_TAG" "$APK_PATH" \
            --title "$RELEASE_NAME" \
            --notes "Automated preview build release for internal testing."
